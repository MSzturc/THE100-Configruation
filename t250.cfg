[include mainsail.cfg]
[include config/boards/btt-kraken/config.cfg]
[include config/fans/part_fan_cpap.cfg]
[include config/fans/hotend_fan.cfg]
[include config/fans/motor_fan_single.cfg]
[include config/fans/electronic_fan.cfg]
[include config/fans/side_blower_fan_dual.cfg]
[include config/sensors/temp_sensor_host.cfg]
[include config/kinematics/corexy.cfg]
[include config/axis/X/awd_configuration.cfg]
[include config/axis/Y/awd_configuration.cfg]
[include config/axis/Z/z_tilt_TR8x8_1.8deg.cfg]
[include config/beds/ender-3/size.cfg]
[include config/beds/ender-3/config.cfg]
[include config/beds/ender-3/mesh-t250.cfg]
[include config/beds/ender-3/z-tilt-leveling-t250.cfg]

[include config/steppers/generic/5160/54v-1.768a-x.cfg]
[include config/steppers/generic/5160/54v-1.768a-x1.cfg]
[include config/steppers/generic/5160/54v-1.768a-y.cfg]
[include config/steppers/generic/5160/54v-1.768a-y1.cfg]

[include config/steppers/generic/5160/54v-0.5a-z.cfg]
[include config/steppers/generic/5160/54v-0.5a-z1.cfg]
[include config/steppers/generic/5160/54v-0.5a-z2.cfg]

[include config/steppers/generic/5160/54v-0.85a-e.cfg]

[include config/endstops/sensorless/5160-awd.cfg]

[include config/extruders/t250.cfg]
[include config/hotends/rapido-uhf.cfg]

[include config/boards/fysetc-pis/config.cfg]
[include config/probes/bdsensor.cfg]
[include config/lights/neopixel_light_bar.cfg]

#####################################################################
#      Extruder Settings
#####################################################################

[mcu]
serial: /dev/btt-kraken
cpu: stm32h723xx

[mcu adxl]
serial: /dev/fysetc-pis
cpu: rp2040

[extruder]
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114

[safe_z_home]
home_xy_position: 96, 106
speed: 200
z_hop: 3
z_hop_speed: 50

# Workaround: There is an issue where BDSensor is not able to use renamed
# Pins
[BDsensor]
sda_pin = PG1
scl_pin = PE9

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 87.8
shaper_type_y = mzv
shaper_freq_y = 62.8

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
number_of_results_to_keep: 3
keep_raw_csv: False
show_macros_in_webui: True
timeout: 300

[gcode_arcs]
resolution: 1.0

[autotune_tmc stepper_x]
motor: ldo-42sth48-2804ah-custom
tuning_goal: performance
voltage: 54
sense_resistor: 0.022
tbl: 0
toff: 2
#pwm_freq_target: 40e3

[autotune_tmc stepper_x1]
motor: ldo-42sth48-2804ah-custom
tuning_goal: performance
voltage: 54
sense_resistor: 0.022
tbl: 0
toff: 2
#pwm_freq_target: 40e3

[autotune_tmc stepper_y]
motor: ldo-42sth48-2804ah-custom
tuning_goal: performance
voltage: 54
sense_resistor: 0.022
tbl: 0
toff: 2
#pwm_freq_target: 40e3

[autotune_tmc stepper_y1]
motor: ldo-42sth48-2804ah-custom
tuning_goal: performance
voltage: 54
sense_resistor: 0.022
tbl: 0
toff: 2
#pwm_freq_target: 40e3

#####################################################################
#      Macros
#####################################################################

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    G32
    PRIME_LINE

[gcode_macro G32]
gcode:
    {% set CALIBRATE_ACCEL = 10000 %}
    {% set RUN_ACCEL = printer.configfile.settings['printer'].max_accel|int %}

    BED_MESH_CLEAR

    # Home
    G28
    
    SET_VELOCITY_LIMIT ACCEL={CALIBRATE_ACCEL}
    Z_TILT_ADJUST

    BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=5
    SET_VELOCITY_LIMIT ACCEL={RUN_ACCEL}
    
	G90
    G0 Z5 F3600
    G0 X96 Y85 F9000

[gcode_macro Z_TILT_ADJUST]
rename_existing: _Z_TILT_ADJUST
description:
gcode:
    #run z tilt with z move up and down at first
    BDSENSOR_SET QGL_TILT_PROBE=1 #set this 1 to enable z axis up and down
    BDSENSOR_SET COLLISION_HOMING=0
    _Z_TILT_ADJUST horizontal_move_z=6 retry_tolerance=1
    G28 Z0
    #run z tilt with no z move up and down
    BDSENSOR_SET QGL_TILT_PROBE=0 #set this 0 to disable z axis up and down while probe
    _Z_TILT_ADJUST horizontal_move_z=1 retry_tolerance=0.04
    #BDSENSOR_SET COLLISION_HOMING=1 #optional
    G28 Z0

[gcode_macro PRIME_LINE]
gcode: 
    {% set SPEED = params.SPEED|default(1500)|int %}
    M117 Prime Line...
    G92 E0 ;Reset Extruder
    # move z axis 
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position 
    G1 X2.0 Y2.0 Z0.28 F5000.0 ;Move to start position
    G1 X188.0 Y2.0 Z0.28 F{SPEED} E20 ;Draw the first line
    G1 X188.0 Y2.3 Z0.28 F5000.0 ;Move to side a little
    G1 X2.0 Y2.3 Z0.28 F{SPEED} E40 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up
